<div class="detail-page-container" *ngIf="member$ | async as member; else loading">

  <!-- Header (Fixed) -->
  <div class="detail-header">
    <div class="header-left-side">
      <button class="back-button" (click)="goBack()" aria-label="Go back">
        <i class="bi bi-arrow-left"></i>
      </button>
      <div class="header-main-info">
        <div class="avatar-placeholder">
          <i class="bi bi-person-fill"></i>
        </div>
        <div class="header-text">
          <h1>{{ member.personalInfo?.firstname }} {{ member.personalInfo?.name }}</h1>
          <div class="status-badges">
            <span class="badge bg-success">Membre Actif</span>
          </div>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="openSendMessageModal()"><i class="bi bi-send"></i> Envoyer un message
      </button>
      <div class="actions-dropdown">
        <button class="btn btn-secondary btn-icon" (click)="toggleActionsDropdown($event)">
          <i class="bi bi-three-dots-vertical"></i>
        </button>
        <ul class="dropdown-menu" [class.show]="isActionsDropdownOpen">
          <li><a (click)="openExportModal()"><i class="bi bi-upload"></i> Exporter</a></li>
          <li><a (click)="toggleDeleteModal()" class="text-danger"><i class="bi bi-trash"></i> Supprimer</a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Body Grid (Two Columns) -->
  <div class="detail-body-grid" [class.sidebar-collapsed]="isSidebarCollapsed">

    <!-- Left Column: Main Info (Scrollable) -->
    <div class="main-content-col">

      <!-- Permanent Info Card: Personal -->
      <div class="permanent-info-card">
        <div class="card-header">
          <h5>Informations Personnelles</h5>
          <button class="btn-modify-card">Modifier</button>
        </div>
        <div class="card-body info-grid">
          <div class="info-pair" *ngFor="let item of objectToArray(member.personalInfo)">
            <span class="info-key">{{ item.key | formatKey }}</span>
            <span class="info-value">
<span *ngIf="item.key === 'birthday'">
  {{ item.value | toDate | date:'d MMMM yyyy' }}
</span>

<ng-container *ngIf="item.key === 'maritalStatus'">
  <span *ngIf="item.value === 'SINGLE'">Célibataire</span>
  <span *ngIf="item.value === 'MARRIED'">Marié(e)</span>
  <span *ngIf="item.value !== 'SINGLE' && item.value !== 'MARRIED'">{{ item.value }}</span>
</ng-container>

<span *ngIf="item.value === true || item.value === false">
  <i class="bi"
     [ngClass]="item.value ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger'"></i>
</span>

<span *ngIf="item.key !== 'birthday' && item.key !== 'maritalStatus' && !(item.value === true || item.value === false)">
  {{ item.value }}
</span>

            </span>
          </div>
        </div>
      </div>

      <!-- Permanent Info Card: Contact -->
      <div class="permanent-info-card">
        <div class="card-header">
          <h5>Informations de Contact</h5>
          <button class="btn-modify-card">Modifier</button>
        </div>
        <div class="card-body info-grid">
          <ng-container *ngFor="let item of objectToArray(member.contactInfo)">

            <!-- Special Case for PersonToCalls Array -->
            <ng-container *ngIf="item.key === 'personToCalls' && item.value.length > 0">
              <div class="info-pair full-width">
                <span class="info-key">{{ item.key | formatKey }}</span>
                <div class="contact-list">
                  <div class="contact-card" *ngFor="let contact of item.value">
                    <div class="contact-name">{{ contact.firstname }} {{ contact.lastname }}</div>
                    <div class="contact-relation">{{ contact.relationship }}</div>
                    <a [href]="'tel:' + contact.requiredNumberPhone" class="contact-phone">
                      <i class="bi bi-telephone-fill"></i> {{ contact.requiredNumberPhone }}
                    </a>
                  </div>
                </div>
              </div>
            </ng-container>

            <!-- Default Case for other key-value pairs -->
            <ng-container *ngIf="item.key !== 'personToCalls'">
              <div class="info-pair">
                <span class="info-key">{{ item.key | formatKey }}</span>
                <span class="info-value">
                  <ng-container [ngSwitch]="true">
                    <a *ngSwitchCase="item.key === 'email'" [href]="'mailto:' + item.value">{{ item.value }}</a>
                    <a *ngSwitchCase="item.key === 'numberPhone'" [href]="'tel:' + item.value">{{ item.value }}</a>
                    <span *ngSwitchDefault>{{ item.value }}</span>
                  </ng-container>
                </span>
              </div>
            </ng-container>

          </ng-container>
        </div>
      </div>

      <!-- Collapsible sections for other info -->
      <app-info-section *ngIf="member.academicInfo?.institutionName" title="Informations Académiques"
                        [data]="member.academicInfo"></app-info-section>
      <app-info-section *ngIf="member.membershipInfo?.legacyInstitution" title="Informations d'Adhésion Complémentaires"
                        [data]="member.membershipInfo"></app-info-section>
      <app-info-section *ngIf="member.addressInfo?.addressInDakar" title="Adresse"
                        [data]="member.addressInfo"></app-info-section>
      <app-info-section *ngIf="member.bourse?.bourseId" title="Bourse" [data]="member.bourse"></app-info-section>
    </div>

    <!-- Right Column: History & Status (Scrollable) -->
    <div class="sidebar-col">
      <div class="sidebar-card">
        <div class="sidebar-header">
          <h4 *ngIf="!isSidebarCollapsed">Historique des inscriptions</h4>
          <button class="btn-icon btn-toggle-sidebar" (click)="toggleSidebar()" [title]="isSidebarCollapsed ? 'Agrandir' : 'Réduire'">
            <i class="bi" [ngClass]="isSidebarCollapsed ? 'bi-chevron-double-left' : 'bi-chevron-double-right'"></i>
          </button>
        </div>
        <div class="sidebar-content" *ngIf="!isSidebarCollapsed">

          <!-- Subscription Summary -->
          <div class="cotisation-summary" *ngIf="contributionSummary">
            <div class="summary-item">
              <span class="summary-value">{{ contributionSummary.totalPaid | currency:'XOF':'symbol':'1.0-0' }}</span>
              <span class="summary-label">Total Payé</span>
            </div>
            <div class="summary-item">
              <span class="summary-value">{{ contributionSummary.totalDue | currency:'XOF':'symbol':'1.0-0' }}</span>
              <span class="summary-label">Restant Dû</span>
            </div>
            <div class="summary-item">
              <span class="summary-value">{{ contributionSummary.completionRate }}</span>
              <span class="summary-label">Complétion</span>
            </div>
          </div>

          <!-- Subscription Status -->
          <h5>État des Cotisations</h5>
          <div class="cotisation-header">
            <div class="year-selector-group">
              <label for="subscription-year">Session :</label>
              <select id="subscription-year" class="form-select-sm" (change)="onYearChange($event)">
                <option *ngFor="let year of subscriptionYears" [value]="year"
                        [selected]="year === selectedSubscriptionYear">
                  {{ year }} - {{ year + 1 }}
                </option>
              </select>
            </div>
          </div>
          <div class="cotisation-grid">
            <button *ngFor="let item of monthlyContributions" 
                    class="month-box" 
                    [ngClass]="item.status"
                    [class.selected]="isMonthSelected(item)"
                    (click)="onMonthClick(item)">
              {{ item.month }}
            </button>
          </div>
          <div class="cotisation-legend">
            <div class="legend-item"><span class="legend-color paid"></span>Payé</div>
            <div class="legend-item"><span class="legend-color delayed"></span>En retard</div>
            <div class="legend-item"><span class="legend-color pending"></span>À venir</div>
            <div class="legend-item"><span class="legend-color not-applicable"></span>Non applicable</div>
          </div>

          <!-- Multi-select Action Bar -->
          <div class="multi-select-bar" *ngIf="selectedContributions.length > 0">
            <div class="selection-info">
              <strong>{{ selectedContributions.length }} mois sélectionnés</strong>
              <span>Total: {{ selectedTotalAmount | currency:'XOF':'symbol':'1.0-0' }}</span>
            </div>
            <button class="btn btn-primary" (click)="openRecordPaymentModal()">Enregistrer le paiement</button>
          </div>

          <div class="cotisation-actions">
            <button class="btn btn-sm btn-secondary" (click)="sendContributionReminder()">
              <i class="bi bi-bell"></i> Envoyer un rappel
            </button>
          </div>

          <hr class="sidebar-divider">

          <!-- Registration History -->
          <div class="registration-history"
               *ngIf="member.registration && member.registration.length > 0; else noRegistrations">
            <div class="registration-item" *ngFor="let reg of member.registration">
            <div class="registration-info">
              <div class="registration-year">Session {{ reg.session }}</div>
              <div class="registration-details">
                <span class="badge" [ngClass]="reg.statusPayment ? 'bg-success' : 'bg-warning'">
                  {{ reg.statusPayment ? 'Payé' : 'En attente' }}
                </span>
                <span class="registration-type">{{ reg.registrationType }}</span>
              </div>
            </div>
            <div class="registration-actions" *ngIf="!reg.statusPayment">
              <button class="btn btn-sm btn-icon-primary" title="Marquer comme Payé" (click)="markAsPaid(reg.session)">
                <i class="bi bi-check-circle"></i>
              </button>
              <button class="btn btn-sm btn-icon-secondary" title="Envoyer un rappel SMS">
                <i class="bi bi-bell"></i>
              </button>
            </div>
          </div>
          </div>
          <ng-template #noRegistrations>
            <p>Aucun historique d'inscription.</p>
          </ng-template>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Fallback & Modals -->
<ng-template #loading>
  <p>Loading member details...</p>
</ng-template>

<ng-template #notFound>
  <p>Member not found.</p>
</ng-template>

<app-reregister-modal *ngIf="isReregisterModalOpen" (close)="toggleReregisterModal()"
                      (save)="handleSaveRegistration($event)"></app-reregister-modal>
<app-confirm-delete-modal *ngIf="isDeleteModalOpen" [itemCount]="1" (close)="toggleDeleteModal()"
                          (confirm)="onDeleteConfirmed()"></app-confirm-delete-modal>
<app-send-message-modal *ngIf="isSendMessageModalOpen" (close)="closeSendMessageModal()"></app-send-message-modal>
<app-export-modal *ngIf="isExportModalOpen" (close)="closeExportModal()"></app-export-modal>

<!-- Record Payment Modal -->
<app-record-payment-modal *ngIf="isRecordPaymentModalOpen"
                          [contributions]="selectedContributions"
                          (close)="handleClosePaymentModal()"
                          (save)="handleSavePayment($event)">
</app-record-payment-modal>
