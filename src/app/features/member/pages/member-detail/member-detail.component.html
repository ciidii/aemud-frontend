<div *ngIf="member$ | async as member; else loading" class="detail-page-container">

  <!-- Header (Fixed) -->
  <div class="detail-header">
    <div class="header-left-side">
      <button (click)="goBack()" aria-label="Go back" class="back-button">
        <i class="bi bi-arrow-left"></i>
      </button>
      <div class="header-main-info">
        <div class="avatar-placeholder">
          <i class="bi bi-person-fill"></i>
        </div>
        <div *ngIf="member.personalInfo" class="header-text">
          <h1>{{ member.personalInfo.firstname }} {{ member.personalInfo.name }}</h1>
          <div class="status-badges">
            <span class="badge bg-success">Membre Actif</span>
          </div>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <button (click)="openSendMessageModal()" class="btn btn-primary"><i class="bi bi-send"></i> Envoyer un message
      </button>
      <div class="actions-dropdown">
        <button (click)="toggleActionsDropdown($event)" class="btn btn-secondary btn-icon">
          <i class="bi bi-three-dots-vertical"></i>
        </button>
        <ul [class.show]="isActionsDropdownOpen" class="dropdown-menu">
          <li><a (click)="openExportModal()"><i class="bi bi-upload"></i> Exporter</a></li>
          <li><a (click)="toggleDeleteModal()" class="text-danger"><i class="bi bi-trash"></i> Supprimer</a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Body Grid (Two Columns) -->
  <div [class.sidebar-collapsed]="isSidebarCollapsed" class="detail-body-grid">

    <!-- Left Column: Main Info (Scrollable) -->
    <div class="main-content-col">

      <!-- Personal Info Card -->
      <div *ngIf="member.personalInfo as personalInfo" class="permanent-info-card">
        <div class="card-header">
          <h5>Informations Personnelles</h5>
          <button (click)="openEditPersonalInfoModal()" class="btn-modify-card">Modifier</button>
        </div>
        <div class="card-body info-grid">
          <div class="info-pair">
            <span class="info-key">Nom complet</span>
            <span class="info-value">{{ personalInfo.firstname }} {{ personalInfo.name }}</span>
          </div>
          <div class="info-pair">
            <span class="info-key">Nationalité</span>
            <span class="info-value">{{ personalInfo.nationality }}</span>
          </div>
          <div class="info-pair">
            <span class="info-key">Genre</span>
            <span class="info-value">{{ personalInfo.gender }}</span>
          </div>
          <div class="info-pair">
            <span class="info-key">Date de naissance</span>
            <span class="info-value">{{ personalInfo.birthday | toDate | date:'d MMMM yyyy' }}</span>
          </div>
          <div class="info-pair">
            <span class="info-key">Statut Marital</span>
            <span class="info-value">{{ personalInfo.maritalStatus }}</span>
          </div>
        </div>
      </div>


      <!-- Contact Info Card -->
      <div *ngIf="member.contactInfo as contactInfo" class="permanent-info-card">
        <div class="card-header">
          <h5>Informations de Contact</h5>
          <button (click)="openEditContactInfoModal()" class="btn-modify-card">Modifier</button>
        </div>
        <div class="card-body info-grid">
          <div class="info-pair">
            <span class="info-key">Numéro de téléphone</span>
            <span class="info-value"><a
              [href]="'tel:' + contactInfo.numberPhone">{{ contactInfo.numberPhone }}</a></span>
          </div>
          <div class="info-pair">
            <span class="info-key">Email</span>
            <span class="info-value"><a [href]="'mailto:' + contactInfo.email">{{ contactInfo.email }}</a></span>
          </div>
          <!-- PersonToCalls -->
          <ng-container *ngIf="contactInfo.personToCalls.length > 0">
            <div class="info-pair full-width">
              <span class="info-key">Personnes à contacter</span>
              <div class="contact-list">
                <div *ngFor="let contact of contactInfo.personToCalls" class="contact-card">
                  <div class="contact-name">{{ contact.firstname }} {{ contact.lastname }}</div>
                  <div class="contact-relation">{{ contact.relationship }}</div>
                  <a [href]="'tel:' + contact.requiredNumberPhone" class="contact-phone">
                    <i class="bi bi-telephone-fill"></i> {{ contact.requiredNumberPhone }}
                  </a>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- Academic & Membership Info Card -->
      <div *ngIf="member.academicInfo || member.membershipInfo" class="permanent-info-card">
        <div class="card-header">
          <h5>Informations Académiques & Adhésion</h5>
          <button (click)="openEditAcademicInfoModal()" class="btn-modify-card">Modifier</button>
        </div>
        <div class="card-body info-grid">
          <ng-container *ngIf="member.academicInfo as academicInfo">
            <div class="info-pair"><span class="info-key">Établissement</span><span
              class="info-value">{{ academicInfo.institutionName }}</span></div>
            <div class="info-pair"><span class="info-key">Domaine d'études</span><span
              class="info-value">{{ academicInfo.studiesDomain }}</span></div>
            <div class="info-pair"><span class="info-key">Niveau d'études</span><span
              class="info-value">{{ academicInfo.studiesLevel }}</span></div>
          </ng-container>
          <ng-container *ngIf="member.membershipInfo as membershipInfo">
            <div class="info-pair"><span class="info-key">Établissement d'origine</span><span
              class="info-value">{{ membershipInfo.legacyInstitution }}</span></div>
            <div class="info-pair"><span class="info-key">Série du BAC</span><span
              class="info-value">{{ membershipInfo.bacSeries }}</span></div>
            <div class="info-pair"><span class="info-key">Mention du BAC</span><span
              class="info-value">{{ membershipInfo.bacMention }}</span></div>
            <div class="info-pair"><span class="info-key">Année du BAC</span><span
              class="info-value">{{ membershipInfo.yearOfBac }}</span></div>
          </ng-container>
        </div>
      </div>

      <!-- Engagements Card -->
      <div class="permanent-info-card">
        <div class="card-header">
          <h5>Engagements Associatifs</h5>
          <button (click)="openEditEngagementsModal()" class="btn-modify-card">Modifier</button>
        </div>
        <div class="card-body">
          <div class="info-pair">
            <span class="info-key">Clubs</span>
            <div *ngIf="member.clubs && member.clubs.length > 0; else noClubs" class="info-value tag-list">
              <span *ngFor="let club of member.clubs" class="tag">{{ club.name }}</span>
            </div>
            <ng-template #noClubs><span class="info-value text-muted">Aucun club</span></ng-template>
          </div>
          <div class="info-pair mt-4">
            <span class="info-key">Commissions</span>
            <div *ngIf="member.commissions && member.commissions.length > 0; else noCommissions"
                 class="info-value tag-list">
              <span *ngFor="let commission of member.commissions" class="tag">{{ commission.name }}</span>
            </div>
            <ng-template #noCommissions><span class="info-value text-muted">Aucune commission</span></ng-template>
          </div>
        </div>
      </div>

      <!-- Religious Knowledge Card -->
      <div *ngIf="member.religiousKnowledge as religiousKnowledge" class="permanent-info-card">
        <div class="card-header">
          <h5>Connaissances Religieuses</h5>
          <button (click)="openEditReligiousKnowledgeModal()" class="btn-modify-card">Modifier</button>
        </div>
        <div class="card-body info-grid">
          <div class="info-pair"><span class="info-key">Niveau de Coran</span><span
            class="info-value">{{ religiousKnowledge.coranLevel }}</span></div>
          <div class="info-pair"><span class="info-key">Maîtrise de l'arabe</span><span
            class="info-value">{{ religiousKnowledge.arabicProficiency }}</span></div>
        </div>
        <div *ngIf="religiousKnowledge.aqida && religiousKnowledge.aqida.length > 0" class="card-body pt-0">
          <h6 class="knowledge-header">Aqida</h6>
          <div class="table-responsive">
            <table class="knowledge-table">
              <thead>
              <tr>
                <th>Livre</th>
                <th>Enseignant</th>
                <th>Lieu</th>
              </tr>
              </thead>
              <tbody>
              <tr *ngFor="let knowledge of religiousKnowledge.aqida">
                <td>{{ knowledge.bookName }}</td>
                <td>{{ knowledge.teacherName }}</td>
                <td>{{ knowledge.learningPlace }}</td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div *ngIf="religiousKnowledge.fiqh && religiousKnowledge.fiqh.length > 0" class="card-body pt-0">
          <h6 class="knowledge-header">Fiqh</h6>
          <div class="table-responsive">
            <table class="knowledge-table">
              <thead>
              <tr>
                <th>Livre</th>
                <th>Enseignant</th>
                <th>Lieu</th>
              </tr>
              </thead>
              <tbody>
              <tr *ngFor="let knowledge of religiousKnowledge.fiqh">
                <td>{{ knowledge.bookName }}</td>
                <td>{{ knowledge.teacherName }}</td>
                <td>{{ knowledge.learningPlace }}</td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Address Card -->
      <div *ngIf="member.addressInfo as addressInfo" class="permanent-info-card">
        <div class="card-header">
          <h5>Adresse</h5>
          <button (click)="openEditAddressInfoModal()" class="btn-modify-card">Modifier</button>
        </div>
        <div class="card-body info-grid">
          <div class="info-pair"><span class="info-key">Adresse à Dakar</span><span
            class="info-value">{{ addressInfo.addressInDakar }}</span></div>
          <div class="info-pair"><span class="info-key">Adresse au Campus</span><span
            class="info-value">{{ addressInfo.addressToCampus }}</span></div>
        </div>
      </div>

      <!-- Bourse Card -->
      <div *ngIf="member.bourse as bourse" class="permanent-info-card">
        <div class="card-header">
          <h5>Bourse</h5>
          <button (click)="openEditBourseInfoModal()" class="btn-modify-card">Modifier</button>
        </div>
        <div *ngIf="bourse.id" class="card-body info-grid">
          <div class="info-pair"><span class="info-key">Libellé</span><span
            class="info-value">{{ bourse.libelle }}</span></div>
          <div class="info-pair"><span class="info-key">Montant</span><span
            class="info-value">{{ bourse.montant | currency:'XOF':'symbol':'1.0-0' }}</span></div>
        </div>
      </div>
    </div>

    <!-- Right Column: History & Status (Scrollable) -->
    <div class="sidebar-col">
      <div class="sidebar-card">
        <div class="sidebar-header">
          <h4 *ngIf="!isSidebarCollapsed">Inscriptions & Cotisations</h4>
          <button (click)="toggleSidebar()" [title]="isSidebarCollapsed ? 'Agrandir' : 'Réduire'"
                  class="btn-icon btn-toggle-sidebar">
            <i [ngClass]="isSidebarCollapsed ? 'bi-chevron-double-left' : 'bi-chevron-double-right'" class="bi"></i>
          </button>
        </div>
        <div *ngIf="!isSidebarCollapsed" class="sidebar-content">

          <!-- Registration Status Card -->
          <div *ngIf="registrationOverview" class="registration-status-card">
            <div class="card-header">
              <h5>Statut d'Inscription Actuel</h5>
            </div>

            <div class="card-body">

              <div *ngIf="registrationOverview.nextRegistrablePhase; else upToDate" class="status-section">

                <!-- Ligne 1 : icône + texte -->
                <div class="status-text d-flex align-items-start gap-2">
                  <i class="bi bi-exclamation-triangle-fill text-warning fs-4"></i>

                  <div class="d-flex flex-column">
                    <strong class="text-dark">Inscription requise</strong>
                    <small class="text-muted"> Dernière inscription :
                      <span class="fw-semibold"> {{ registrationOverview.latestRegistration?.mandatName || 'Aucune' }}
                      </span>
                    </small>
                  </div>
                </div>


                <!-- Ligne 2 : bouton -->
                <button (click)="toggleReregisterModal(registrationOverview.nextRegistrablePhase)"
                        class="btn btn-primary btn-outline-primary">
                  Inscrire à {{ registrationOverview.nextRegistrablePhase.nom }}
                </button>

              </div>

              <ng-template #upToDate>
                <div class="status-section">
                  <div class="status-text">
                    <i class="bi bi-check-circle-fill text-success"></i>
                    <div>
                      <strong>Membre à jour</strong>
                      <span>Inscrit pour: {{ registrationOverview.latestRegistration?.mandatName }}</span>
                    </div>
                  </div>
                </div>
              </ng-template>

            </div>
          </div>
          <!-- Subscription Status -->
          <div class="sidebar-section">
            <h5>État des Cotisations</h5>
            <div class="cotisation-header">
              <div class="year-selector-group">
                <label for="subscription-phase">Phase :</label>
                <select
                  (change)="onPhaseChange($event)"
                  class="form-select-sm w-100"
                  id="subscription-phase"
                >
                  <option
                    *ngFor="let phase of activeMandat?.phases"
                    [value]="phase.id"
                    [selected]="phase.id === selectedPhaseId"
                  >
                    {{ phase.nom }} —
                    du {{ formatArrayDate(phase.dateDebut) }}
                    au {{ formatArrayDate(phase.dateFin) }}
                  </option>
                </select>

              </div>
            </div>
            <div *ngIf="contributionSummary" class="cotisation-summary">
              <div class="summary-item">
                <span class="summary-value">{{ contributionSummary.totalPaid | currency:'XOF':'symbol':'1.0-0' }}</span>
                <span class="summary-label">Total Payé</span>
              </div>
              <div class="summary-item">
                <span class="summary-value">{{ contributionSummary.totalDue | currency:'XOF':'symbol':'1.0-0' }}</span>
                <span class="summary-label">Restant Dû</span>
              </div>
              <div class="summary-item">
                <span class="summary-value">{{ contributionSummary.completionRate }}</span>
                <span class="summary-label">Complétion</span>
              </div>
            </div>

            <app-contribution-calendar
              (monthClicked)="handleMonthClick($event)"
              [calendar]="contributionData?.calendrier || []"
              [selectedMonths]="selectedContributions">
            </app-contribution-calendar>

            <div *ngIf="selectedContributions.length > 0" class="multi-select-bar">
              <div class="selection-info">
                <strong>{{ selectedContributions.length }} mois sélectionnés</strong>
                <span>Total: {{ selectedTotalAmount | currency:'XOF':'symbol':'1.0-0' }}</span>
              </div>
              <button (click)="openRecordPaymentModal()" class="btn btn-primary">Enregistrer le paiement</button>
            </div>
            <div class="cotisation-actions">
              <button (click)="sendContributionReminder()" class="btn btn-sm btn-secondary">
                <i class="bi bi-bell"></i> Envoyer un rappel
              </button>
            </div>
          </div>


          <hr class="sidebar-divider">

          <!-- Registration Timeline -->
          <div class="sidebar-section">
            <h5>Historique des Inscriptions</h5>
            <div *ngIf="timeline$ | async as timeline; else loadingTimeline" class="registration-timeline">
              <div *ngFor="let mandateItem of timeline" class="timeline-mandate-group">
                <h6 class="mandate-title">{{ mandateItem.mandat.nom }}</h6>
                <ul class="timeline-phase-list">
                  <li *ngFor="let phaseItem of mandateItem.phases" class="timeline-phase-item">
                    <div class="phase-info">
                      <i [ngClass]="{
                        'bi-check-circle-fill text-success': phaseItem.status === 'REGISTERED',
                        'bi-exclamation-diamond-fill text-warning': phaseItem.status === 'MISSED_OPEN',
                        'bi-slash-circle-fill text-muted': phaseItem.status === 'MISSED_CLOSED',
                        'bi-hourglass-split text-info': phaseItem.status === 'PENDING'
                      }" class="bi phase-icon"></i>
                      <span class="phase-name">{{ phaseItem.phase.nom }}</span>
                    </div>
                    <div class="phase-status">
                      <ng-container [ngSwitch]="phaseItem.status">
                        <span *ngSwitchCase="'REGISTERED'" class="badge bg-success-light">Inscrit</span>
                        <span *ngSwitchCase="'MISSED_OPEN'" class="badge bg-warning-light">Action requise</span>
                        <span *ngSwitchCase="'MISSED_CLOSED'" class="badge bg-secondary-light">Manqué</span>
                        <span *ngSwitchCase="'PENDING'" class="badge bg-info-light">À venir</span>
                      </ng-container>
                    </div>
                    <div class="phase-actions">
                      <button (click)="toggleReregisterModal(phaseItem.phase)" *ngIf="phaseItem.isRegistrable"
                              class="btn btn-sm btn-outline-primary">
                        S'inscrire
                      </button>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
            <ng-template #loadingTimeline>
              <p>Chargement de l'historique...</p>
            </ng-template>
          </div>

        </div>
      </div>
    </div>
  </div>

</div>

<ng-template #loading>
  <p>Loading member details...</p>
</ng-template>

<ng-template #notFound>
  <p>Member not found.</p>
</ng-template>

<app-reregister-modal (close)="toggleReregisterModal()"
                      (save)="handleSaveRegistration($event)"
                      *ngIf="isReregisterModalOpen"
                      [availableMandats]="availableMandats">
</app-reregister-modal>

<app-confirm-delete-modal (close)="toggleDeleteModal()" (confirm)="onDeleteConfirmed()" *ngIf="isDeleteModalOpen"
                          [itemCount]="1"></app-confirm-delete-modal>
<app-send-message-modal (close)="closeSendMessageModal()" *ngIf="isSendMessageModalOpen"></app-send-message-modal>
<app-export-modal (close)="closeExportModal()" *ngIf="isExportModalOpen"
                  [searchRequest]="searchParamsForExport"></app-export-modal>

<!-- Record Payment Modal -->
<app-record-payment-modal (close)="handleClosePaymentModal()"
                          (save)="handleSavePayment($event)"
                          *ngIf="isRecordPaymentModalOpen"
                          [contributions]="selectedContributions">
</app-record-payment-modal>

<!-- Edit Personal Info Modal -->
<app-edit-personal-info-modal
  (close)="closeEditPersonalInfoModal()"
  (save)="handleSavePersonalInfo($event)"
  *ngIf="isEditPersonalInfoModalOpen && currentMember?.personalInfo"
  [initialData]="currentMember!.personalInfo">
</app-edit-personal-info-modal>

<!-- Edit Contact Info Modal -->
<app-edit-contact-info-modal
  (close)="closeEditContactInfoModal()"
  (save)="handleSaveContactInfo($event)"
  *ngIf="isEditContactInfoModalOpen && currentMember?.contactInfo"
  [initialData]="currentMember!.contactInfo">
</app-edit-contact-info-modal>

<!-- Edit Academic Info Modal -->
<app-edit-academic-info-modal
  (close)="closeEditAcademicInfoModal()"
  (save)="handleSaveAcademicInfo($event)"
  *ngIf="isEditAcademicInfoModalOpen">
</app-edit-academic-info-modal>

<app-edit-engagements-modal
  (close)="closeEditEngagementsModal()"
  (save)="handleSaveEngagements($event)"
  *ngIf="isEditEngagementsModalOpen && currentMember"
  [memberClubs]="currentMember.clubs || []"
  [memberCommissions]="currentMember.commissions || []">
</app-edit-engagements-modal>

<!-- Edit Religious Knowledge Modal -->
<app-edit-religious-knowledge-modal
  (close)="closeEditReligiousKnowledgeModal()"
  (save)="handleSaveReligiousKnowledge($event)"
  *ngIf="isEditReligiousKnowledgeModalOpen && currentMember?.religiousKnowledge"
  [initialData]="currentMember!.religiousKnowledge">
</app-edit-religious-knowledge-modal>

<!-- Edit Address Info Modal -->
<app-edit-address-info-modal
  (close)="closeEditAddressInfoModal()"
  (save)="handleSaveAddressInfo($event)"
  *ngIf="isEditAddressInfoModalOpen && currentMember?.addressInfo"
  [initialData]="currentMember!.addressInfo">
</app-edit-address-info-modal>

<!-- Edit Bourse Info Modal -->
<app-edit-bourse-info-modal
  (close)="closeEditBourseInfoModal()"
  (save)="handleSaveBourseInfo($event)"
  *ngIf="isEditBourseInfoModalOpen && currentMember?.bourse"
  [initialData]="currentMember!.bourse">
</app-edit-bourse-info-modal>

